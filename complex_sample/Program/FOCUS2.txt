-* FOCUS2.fex
-SET &ECHO = ALL;
SET NODATA = ' ';
SET HOLDLIST = PRINTONLY
EX FOCDATE

-* ab) Address fields on EMPLOYEE
DEFINE FILE EMPLOYEE
  HOUSE_NUMBER/A20  = HOUSE_NO;
  ADDRESS_LINE1/A60 = ADDR1;
  ADDRESS_LINE2/A60 = ADDR2;
  CITY/A40          = CITY_NAME;
  PROVINCE/A40      = PROVINCE_NAME;
  COUNTRY/A40       = COUNTRY_NAME;
  PIN_CODE/A12      = PINCODE;
END

-* ac) Pull addresses -> EMPADDR_SRC
TABLE FILE EMPLOYEE
  PRINT EMPID HOUSE_NUMBER ADDRESS_LINE1 ADDRESS_LINE2 CITY PROVINCE COUNTRY PIN_CODE
  ON TABLE HOLD AS EMPADDR_SRC FORMAT FOCUS
END
-RUN

-* ad) Full outer match with UID on EMPID (include rows with missing columns)
JOIN FULL_OUTER EMPID IN EMPADDR_SRC TO UID.EMPID IN UID AS J_ADDR_UID;

-* ae) Missing-field flags and comparison view -> EMPUID_MERGE
TABLE FILE EMPADDR_SRC
  PRINT
    EMPADDR_SRC.EMPID
    EMPADDR_SRC.HOUSE_NUMBER  AS EMP_HOUSE
    UID.HOUSE_NUMBER          AS UID_HOUSE
    EMPADDR_SRC.ADDRESS_LINE1 AS EMP_ADDR1
    UID.ADDRESS_LINE1         AS UID_ADDR1
    EMPADDR_SRC.ADDRESS_LINE2 AS EMP_ADDR2
    UID.ADDRESS_LINE2         AS UID_ADDR2
    EMPADDR_SRC.CITY          AS EMP_CITY
    UID.CITY                  AS UID_CITY
    EMPADDR_SRC.PROVINCE      AS EMP_PROV
    UID.PROVINCE              AS UID_PROV
    EMPADDR_SRC.COUNTRY       AS EMP_CNTRY
    UID.COUNTRY               AS UID_CNTRY
    EMPADDR_SRC.PIN_CODE      AS EMP_PIN
    UID.PIN_CODE              AS UID_PIN
  COMPUTE EMP_MISS/A1 = IF EMPADDR_SRC.EMPID IS MISSING OR
                          EMPADDR_SRC.HOUSE_NUMBER IS MISSING OR
                          EMPADDR_SRC.ADDRESS_LINE1 IS MISSING OR
                          EMPADDR_SRC.CITY IS MISSING OR
                          EMPADDR_SRC.PROVINCE IS MISSING OR
                          EMPADDR_SRC.COUNTRY IS MISSING OR
                          EMPADDR_SRC.PIN_CODE IS MISSING THEN 'Y' ELSE 'N';
  COMPUTE UID_MISS/A1 = IF UID.EMPID IS MISSING OR
                          UID.HOUSE_NUMBER IS MISSING OR
                          UID.ADDRESS_LINE1 IS MISSING OR
                          UID.CITY IS MISSING OR
                          UID.PROVINCE IS MISSING OR
                          UID.COUNTRY IS MISSING OR
                          UID.PIN_CODE IS MISSING THEN 'Y' ELSE 'N';
  ON TABLE HOLD AS EMPUID_MERGE FORMAT FOCUS
END
JOIN CLEAR *
-RUN

-* af) Excel report of the address match
SET ODS EXCEL ON
SET ODS EXCEL FORMAT=AUTO
TABLE FILE EMPUID_MERGE
  HEADING
  "Employee vs UID Address Match"
  "Generated: <+0>&YYMD"
  PRINT *
  ON TABLE XCL2 FORMAT XLSX
  ON TABLE SET SHEETNAME 'Emp-UID Address'
  ON TABLE SET STYLE *
    TYPE=HEADING, STYLE=BOLD, SIZE=12, JUSTIFY=CENTER, $
    TYPE=TITLE,   STYLE=BOLD, $
  ENDSTYLE
END
SET ODS EXCEL OFF

-* ag) Rows with no missing fields -> EMPADDR
TABLE FILE EMPUID_MERGE
  PRINT *
  WHERE EMP_MISS EQ 'N' AND UID_MISS EQ 'N';
  ON TABLE HOLD AS EMPADDR FORMAT FOCUS
END
